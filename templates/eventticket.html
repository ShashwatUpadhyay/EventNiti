{% extends "index.html" %}
{% load static %}
{% block title %}
Event Ticket | {{company_name}} â€“ Your Official Entry Pass
{% endblock title %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet" />

<div class="min-h-screen bg-gradient-to-tr pt-[150px] from-white via-blue-50 to-blue-100 px-4 py-16 font-[Outfit]">
  <div id="ticket" class="max-w-4xl mx-auto flex flex-col md:flex-row overflow-hidden rounded-3xl shadow-2xl border-4 border-blue-300 bg-white relative print:shadow-none print:border-none transition-all duration-500 animate-fade-up">

    <!-- Decorative Side Strip -->
    <div class="bg-gradient-to-b from-blue-600  to-indigo-500 text-white py-12 px-6 w-full md:w-1/3 flex flex-col justify-between items-center relative">
      <div class="space-y-2 text-center">
        <h3 class="text-2xl font-bold">ğŸŸ {{company_name}} Pass</h3>
        <p class="text-sm text-blue-100 italic">Official Ticket</p>
      </div>

      <div class="mt-10">
        <img src="{% static 'images/en2.png' %}" alt="Logo" class="w-auto h-20 rounded-xl border-2 border-white shadow-lg" />
      </div>

      <div class="mt-auto">
        <p class="text-xs text-blue-100 text-center">Scan on entry to validate</p>
      </div>
    </div>

    <!-- Ticket Main Body -->
    <div class="w-full md:w-2/3 px-8 py-10">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-extrabold text-blue-700">Event Entry Ticket</h2>
        <span class="bg-blue-100 text-blue-600 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">#{{ ticket.uid }}</span>
      </div>

      <div class="space-y-4 text-gray-700">
        <p><strong>ğŸ‘¤ Attendee:</strong> {{ ticket.user.get_full_name }}</p>
        <p><strong>ğŸ“… Date:</strong> {{ ticket.event.start_date|date:"F j, Y â€“ g:i A" }}</p>
        <p><strong>ğŸ“Œ Event:</strong> {{ ticket.event.title }}</p>
      </div>

      <!-- QR Code -->
      <div class="my-8 flex justify-center">
        <div class="border-2 border-blue-200 p-4 rounded-xl shadow-sm">
          <img src="data:image/png;base64,{{ qrCode }}" alt="QR Code" class="w-32 h-32" />
        </div>
      </div>

      <p class="text-sm text-center text-gray-500">
        This ticket is non-transferable. Carry a valid ID for verification.
      </p>
    </div>
  </div>

  <!-- Download Button -->
  <div class="text-center mt-10">
    <button
      id="download-btn"
      class="bg-gradient-to-r from-blue-600 to-blue-500 text-white font-semibold py-3 px-12 rounded-full shadow-lg hover:scale-105 hover:shadow-xl transition-transform duration-300"
    >
      â¬‡ï¸ Download Ticket as PDF
    </button>
  </div>
</div>

<!-- Animations -->
<style>
  @keyframes fade-up {
    from {
      opacity: 0;
      transform: translateY(40px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-fade-up {
    animation: fade-up 0.8s ease-out;
  }
  @media print {
    #download-btn,
    .animate-fade-up {
      display: none !important;
    }
    body {
      background: white !important;
    }
    #ticket {
      box-shadow: none !important;
      border: none !important;
    }
  }
</style>

<!-- HTML2PDF Script -->
<script>
  document.getElementById("download-btn").addEventListener("click", async () => {
    const element = document.getElementById("ticket");

    // Clone the certificate cleanly
    const cloned = element.cloneNode(true);
    cloned.style.animation = "none";
    cloned.style.background = "white"; // Set white background
    cloned.style.color = "black";
    cloned.style.minHeight = '100vh';  // ensure full height

    // Temporarily hide unnecessary elements
    cloned.querySelectorAll(".no-print").forEach((el) => (el.style.display = "none"));

    // Create a temporary wrapper so html2canvas has clean context
    const tempWrapper = document.createElement("div");
    tempWrapper.style.padding = "20px";
    tempWrapper.style.background = "white";

    tempWrapper.appendChild(cloned);

    document.body.appendChild(tempWrapper);

    // Use html2canvas to capture the image
    try {
        const canvas = await html2canvas(tempWrapper, {
            scale: 3,
            useCORS: true, // important if using external images like QR code
            allowTaint: true,
        });

        // Convert the canvas to an image data URL (in PNG format)
        const imgData = canvas.toDataURL("image/png");

        // Create a link to trigger download
        const link = document.createElement("a");
        link.href = imgData;
        link.download = "{{ticket.event.slug}}-ticket.png"; // specify file name
        link.click();
    } catch (error) {
        console.error("Error generating image: ", error);
    } finally {
        // Remove the temporary wrapper after use
        document.body.removeChild(tempWrapper);
    }
});
</script>{% endblock content %}
