{% extends "index.html" %}
{% block title %}
{{ event.title }} Event | {{ company_name }}
{% endblock title %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="min-h-screen bg-gray-100 py-10 px-4 sm:px-6 lg:px-12 pt-[100px]">
  <div class="max-w-7xl mx-auto space-y-12">
    {% include 'task/back_button.html' %}

    <!-- üßä Sexy Glassmorphic Header -->
    <div class="relative rounded-3xl border border-white/30 bg-white/20 backdrop-blur-xl shadow-2xl p-8 text-center animate-fade-in">
      <h1 class="text-5xl font-extrabold text-indigo-800 drop-shadow-xl tracking-tight flex justify-center items-center gap-2">
        üó≥Ô∏è {{ event.title }}
      </h1>
      <p class="text-md text-gray-700 mt-2 italic">Poll Results Overview</p>
    </div>

    <!-- üìä Polls Grid -->
    <div class="gap-8 justify-center">
      {% for poll_data in polls_with_votes %}
        {% with poll=poll_data.poll options=poll_data.options total_votes=poll_data.total_votes %}

        <!-- üîÆ Poll Card -->
        <div class="bg-white my-4 rounded-xl shadow-2xl p-6 w-full sm:h-[100%] lg:h-[50%] sm:w-[45%] lg:w-[100%] hover:scale-[1.025] transition-all duration-300 ease-in-out group">

          <!-- Question -->
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-indigo-700 group-hover:text-purple-600 transition">{{ poll.question }}</h2>
            <p class="text-sm text-gray-500">Total Votes: {{ total_votes }}</p>
          </div>
        
          <!-- Poll Bars -->

          <div class="flex flex-col lg:flex-row gap-8">
            <!-- Options and Vote Bars -->
            <div class="space-y-6 flex-1">
              {% for option in options %}
              <div class="group">
                <div class="flex justify-between items-center mb-1">
                  <div class="flex items-center">
                    <span class="mr-2 text-indigo-600">üó≥Ô∏è</span>
                    <span class="text-sm font-medium text-gray-700 group-hover:text-indigo-600 transition-colors">
                      {{ option.option }}
                    </span>
                  </div>
                  <a href='{% url "voters" option.uid %}' class="hover:underline">
                    <span class="text-xs font-semibold text-gray-500 hover:text-indigo-600 transition-colors">
                      {{ option.votes }} vote{{ option.votes|pluralize }}
                    </span>
                  </a>
                </div>
                <div class="w-full bg-gray-200 h-3 rounded-full overflow-hidden">
                  <div 
                    class="bg-gradient-to-r from-indigo-500 to-purple-600 h-full text-white text-xs text-center rounded-full transition-all duration-700 ease-out"
                    style="width: {% widthratio option.votes total_votes 100 %}%;"
                    data-percentage="{% widthratio option.votes total_votes 100 %}"
                  >
                    <span class="opacity-0">{% widthratio option.votes total_votes 100 %}%</span>
                  </div>
                </div>
                <div class="text-right mt-1">
                  <span class="text-xs font-medium text-indigo-600">
                    {% widthratio option.votes total_votes 100 %}%
                  </span>
                </div>
              </div>
              {% endfor %}
            </div>
          
            <!-- Chart -->
            <div class="flex-1 bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex justify-center items-center max-h-[300px]">
              <canvas 
                id="chart-{{ forloop.counter }}" 
                class="w-full "
                data-options='{{ options_json|safe }}'
                data-total='{{ total_votes }}'
              ></canvas>
            </div>
          </div>
          
          

          <!-- Chart Script -->
          <script>
            const ctx{{ forloop.counter }} = document.getElementById('chart-{{ forloop.counter }}').getContext('2d');
            new Chart(ctx{{ forloop.counter }}, {
              type: 'pie',  <!-- Change type from 'doughnut' to 'pie' -->
              data: {
                labels: [{% for option in options %}"{{ option.option }}"{% if not forloop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                  data: [{% for option in options %}{{ option.votes }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                  backgroundColor: [
                    '#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981',
                    '#ef4444', '#0ea5e9', '#14b8a6', '#a855f7'
                  ],
                  borderColor: '#fff',
                  borderWidth: 2
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                      color: '#4b5563',
                      font: { size: 14 }
                    }
                  }
                },
                animation: {
                  animateScale: true,  <!-- Keeps the scale animation for the pie chart -->
                  animateRotate: true   <!-- Rotating animation for pie chart -->
                }
              }
            });
          </script>

        </div>
        {% endwith %}
      {% endfor %}
    </div>

    <!-- üîô Back Button -->
    <div class="text-center mt-12">
      {% if is_cordinator or is_host %}
      <a href="{% url 'teacherEvent' event.slug %}"
         class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-md text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 transition-all duration-300">
        ‚¨Ö Back to Event
      </a>
      {% else %}
      <a href="{% url 'event' event.slug %}"
         class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-xl shadow-md text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 transition-all duration-300">
        ‚¨Ö Back to Event
      </a>
      {% endif %}
    </div>

  </div>
</div>

<script>
  // This would be part of your chart initialization
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize progress bar animations
    document.querySelectorAll('.bg-gradient-to-r').forEach(bar => {
      const percentage = bar.getAttribute('data-percentage');
      bar.style.setProperty('--target-width', percentage + '%');
    });

    // Chart initialization code would go here
    // You would use the data-options and data-total attributes
  });
</script>
{% endblock content %}
