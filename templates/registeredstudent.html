{% extends "index.html" %}

{% block title %}
Registered Students
{% endblock title %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<div class="bg-gradient-to-br from-indigo-100 via-white to-blue-100 min-h-screen py-12 pt-[100px]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Header Section -->
        <div class="bg-gradient-to-r from-indigo-700 to-blue-700 text-white p-8 rounded-2xl shadow-lg mb-10 animate-fade-in">
            <h1 class="text-4xl font-extrabold tracking-tight">ğŸ“‹ Registered Students</h1>
            <p class="mt-2 text-indigo-200 text-lg">Event: <span class="text-green-300 font-semibold">{{ event.title }} | {{ event.start_date }}</span></p>
        </div>

        <!-- Table Section -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden animate-slide-in">
            {% if students %}
            <div class="overflow-x-auto">
                <table id="table" class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-indigo-600 text-white uppercase text-xs">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left tracking-wider">UUID</th>
                            <th scope="col" class="px-6 py-3 text-left tracking-wider">Full Name</th>
                            <th scope="col" class="px-6 py-3 text-left tracking-wider">Email</th>
                            <th scope="col" class="px-6 py-3 text-left tracking-wider">Course</th>
                            <th scope="col" class="px-6 py-3 text-left tracking-wider">Section</th>
                            <th scope="col" class="px-6 py-3 text-left tracking-wider">Year</th>
                            <th scope="col" class="px-6 py-3 text-left tracking-wider">Attendance</th>
                            <th scope="col" class="px-6 py-3 text-left tracking-wider">Taken By</th>
                            <th scope="col" class="px-6 py-3 text-left tracking-wider">Allowed</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for student in students %}
                        <tr class="hover:bg-indigo-50">
                            <td class="px-6 py-4">{{ student.uu_id }}</td>
                            <td class="px-6 py-4">{{ student.full_name }}</td>
                            <td class="px-6 py-4">{{ student.email }}</td>
                            <td class="px-6 py-4">{{ student.course }}</td>
                            <td class="px-6 py-4">{{ student.section }}</td>
                            <td class="px-6 py-4">{{ student.year }}</td>
                            <td class="px-6 py-4">
                                {% if student.attendence == 'Present' %}
                                    <span class="inline-block bg-green-100 text-green-700 text-xs font-semibold px-3 py-1 rounded-full">Present</span>
                                {% else %}
                                    <span class="inline-block bg-red-100 text-red-700 text-xs font-semibold px-3 py-1 rounded-full">Absent</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4">{{ student.attendence_taken_by|default:"-" }}</td>
                            <td class="px-6 py-4">
                                {% if student.allowed %}
                                    <span class="inline-block bg-green-50 text-green-700 text-xs font-semibold px-3 py-1 rounded-full">Yes</span>
                                {% else %}
                                    <span class="inline-block bg-red-50 text-red-700 text-xs font-semibold px-3 py-1 rounded-full">No</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="py-8 flex justify-center">
                <div class="bg-yellow-100 border border-yellow-400 text-yellow-800 px-6 py-4 rounded-xl shadow">
                    No registrations yet.
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Download Button -->
        <div class="mt-10 flex justify-center">
            <a href='{% url "registeredStudentListCSV" event.slug %}' class="bg-indigo-700 hover:bg-indigo-800 text-white font-bold py-3 px-8 rounded-lg shadow transition-transform transform hover:scale-105">
                ğŸ“¥ Download Current Status
            </a>
        </div>
    </div>
</div>

<style>
    @keyframes fade-in {
        0% { opacity: 0; transform: translateY(-10px); }
        100% { opacity: 1; transform: translateY(0); }
    }
    @keyframes slide-in {
        0% { opacity: 0; transform: translateY(20px); }
        100% { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in { animation: fade-in 1s ease-out; }
    .animate-slide-in { animation: slide-in 1s ease-out; }
</style>

<script>
    const formatter = new Intl.DateTimeFormat("en-US", {
        timeZone: "Asia/Kolkata",
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: true,
    });

    const indiaTime = formatter.format(new Date());

    document.getElementById("download-btn").addEventListener("click", () => {
        const element = document.getElementById("table");
        const opt = {
            margin: [0.5, 0.5, 0.5, 0.5],
            filename: `{{ event.title }}_${indiaTime}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 3, useCORS: true },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
        };

        element.style.width = "100%";
        element.style.maxWidth = "100%";

        html2pdf().set(opt).from(element).save();
    });

    const eventSlug = "{{ event.slug }}";

    function fetchStudents() {
        $.ajax({
            url: "{% url 'registeredStudentListAjax' event.slug %}",
            type: 'GET',
            dataType: 'json',
            success: function(data) {
                updateStudentTable(data.students);
                console.log(data.students);
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error:", status, error);
                console.log(xhr.responseText);

                console.log("Failed to fetch data");
            }
        });
    }

    function updateStudentTable(students) {
        let tableBody = document.querySelector("#table tbody");
        tableBody.innerHTML = "";

        students.forEach(student => {
            let attendenceClass = student.attendence === 'Present' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
            let attendenceText = student.attendence === 'Present' ? 'Present' : 'Absent';

            tableBody.innerHTML += `
                <tr class="hover:bg-indigo-50">
                    <td class="px-6 py-4">${student.uu_id}</td>
                    <td class="px-6 py-4">${student.full_name}</td>
                    <td class="px-6 py-4">${student.email}</td>
                    <td class="px-6 py-4">${student.course}</td>
                    <td class="px-6 py-4">${student.section}</td>
                    <td class="px-6 py-4">${student.year}</td>

                     <!-- Attendance Column with conditional styling -->
            <td class="px-6 py-4 ${attendenceClass}">
                ${attendenceText}
            </td>

                    <td class="px-6 py-4">${student.attendence_taken_by}</td>
                    <td class="px-6 py-4">${student.allowed}</td>
                </tr>
            `;
        });
    }

    setInterval(fetchStudents, 2000);
    fetchStudents();
</script>
{% endblock content %}