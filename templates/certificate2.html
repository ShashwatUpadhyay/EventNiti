{% extends "index.html" %} {% load static %} {% block title %} ðŸŽ‰ Achievement
Unlocked: {{ certi_obj.event.title }} Certificate! ðŸŽ‰ {% endblock title %} 

{% block head_extra %} {# Font Awesome (kept from previous) #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer"/>
{# Canvas Confetti Library #}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

<script
  src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
  integrity="sha512-YcsIPF6CDmN2HEq4+oEl1+jrEnEXf4XyS92jF3G7gN5hQ/pI0mOMMyL61z7Z9+13n+bz4iZpF5D/w/FYJ1bb4g=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
></script>

{% endblock head_extra %}

{% block content %} 
<div
  class="min-h-screen flex flex-col items-center justify-center py-16 px-4 overflow-x-hidden pt-[100px]"
>
  {# Top intro text with animation #}
  <div
    id="certificate-wrapper"
    class="w-full max-w-4xl lg:max-w-5xl mb-6 no-print"
  >
    <p
      class="text-center text-blue-900 mb-4 text-base sm:text-lg font-medium fade-in-up delay-1300"
      style="text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3)"
    >
      <i class="fas fa-star text-yellow-300"></i> This is Your Moment! Celebrate
      Your Achievement! <i class="fas fa-star text-yellow-300"></i>
    </p>
  </div>

  <div
    
    class="w-full max-w-4xl lg:max-w-5xl mb-10"
  >
    <div id="certificate"
      class="relative bg-white justify-center certificate-pattern rounded-lg shadow-2xl overflow-hidden border-t-8 border-indigo-700 duration-500 mx-auto certificate-corners"
    >
      <div class="relative z-10">
        <div
          class="px-8 py-6 md:px-12 md:py-8 bg-gradient-to-r from-indigo-50 via-white to-purple-50 border-b border-gray-200"
        >
          <div
            class="flex flex-col sm:flex-row justify-between items-center gap-4"
          >
            <div>
              <h1
                class="text-2xl sm:text-3xl md:text-4xl font-bold text-indigo-800 tracking-tight"
              >
                Certificate of {{certi_obj.certificate_for.title}}
              </h1>
              <p class="text-sm sm:text-base text-gray-600 mt-1 italic">
                Awarded for {{certi_obj.certificate_for.title}} in:
                <span class="font-semibold">{{ certi_obj.event.title }}</span>
              </p>
            </div>
            <div
              class="seal-container mt-4 sm:mt-0 w-20 h-20 bg-gradient-to-br from-yellow-300 to-yellow-400 rounded-full flex items-center justify-center border-2 border-amber-600 shadow-lg p-1"
            >
              <div class="pulse-glow">
                <i
                  class="fas fa-medal text-4xl text-white"
                  style="filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.5))"
                ></i>
              </div>
            </div>
          </div>
        </div>

        <div
          class="px-8 py-8 md:px-12 md:py-10 text-center"
        >
          <p class="text-lg text-gray-500 mb-2">Proudly Presented To</p>
          <h2
            class="text-3xl md:text-4xl lg:text-5xl font-semibold text-gray-900 break-words "
            style="
              font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
            "
          >
            {{ certi_obj.user.first_name }} {{ certi_obj.user.last_name }}
          </h2>

          <div class="my-6 text-center scale-in delay-700">
            <svg
              class="inline-block h-4 sm:h-5 text-amber-500"
              viewBox="0 0 100 15"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M0 7.5 C 10 0, 20 0, 30 7.5 S 40 15, 50 7.5 S 60 0, 70 7.5 S 80 15, 90 7.5 S 100 0, 100 7.5"
                stroke="currentColor"
                stroke-width="2"
              />
              <circle cx="50" cy="7.5" r="3" fill="currentColor" />
            </svg>
          </div>

          <p
            class="text-base sm:text-lg text-gray-700 max-w-2xl mx-auto leading-relaxed"
          >
            For successfully completing and demonstrating commendable engagement
            during the
            <span class="font-semibold text-indigo-700"
              >{{ certi_obj.event.title }}</span
            >
            event, hosted with distinction by
            <span class="font-semibold"
              >
              {{ company_name }}
              {% comment %} {{ certi_obj.event.organized_by.get_full_name | default:'Our Platform'}} {% endcomment %}
              </span
            >.
          </p>
        </div>

        <div
          class="px-8 py-6 md:px-12 md:py-8 bg-gray-50 border-t border-gray-200 fade-in-up delay-900"
        >
          <div
            class="flex flex-col md:flex-row justify-between items-center gap-6"
          >
            <div class="flex items-center gap-4 text-center md:text-left">
              <img
                src="data:image/png;base64,{{qr_code_base64}}"
                alt="Verification QR Code"
                class="w-20 h-20 md:w-24 md:h-24 rounded-md shadow-md border-2 border-gray-300 p-1 bg-white transition-transform duration-200 hover:scale-105"
              />
              <div>
                <p
                  class="text-xs text-gray-500 font-semibold uppercase tracking-wider"
                >
                  Issued On
                </p>
                <p class="text-base md:text-lg font-medium text-gray-800">
                  {{ certi_obj.issue_date|date:"F j, Y" }}
                </p>
                <p class="text-xs text-gray-500 mt-2">
                  Scan QR to Verify Authenticity
                </p>
              </div>
            </div>
            <div class="text-center md:text-right w-full md:w-auto">
              <p
                class="text-xs text-gray-500 font-semibold uppercase tracking-wider"
              >
                Authorized By
              </p>
              <p class="font-cursive text-xl text-indigo-700 my-1">
                [Digital Signature Placeholder]
              </p>
              <p class="text-sm font-medium text-gray-800">Event Coordinator</p>
              <p class="mt-3 text-xs text-gray-500 break-all">
                <span class="font-semibold">ID:</span>
                <a
                  href="{% url 'certificate' certi_obj.hash %}"
                  class="text-indigo-600 hover:underline hover:text-amber-600"
                  title="Verify Online"
                >
                  {{ certi_obj.hash }}
                </a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="text-center no-print mt-6 sm:mt-0 fade-in-up delay-1100">
    <p
      class="text-lg text-blue-900 mb-6 font-medium"
      style="text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3)"
    >
      Ready to Share Your Success?
    </p>
    <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
      <button
        id="download-btn"
        class="inline-flex items-center justify-center gap-2 w-full sm:w-auto px-8 py-3 border border-transparent text-base font-medium rounded-md shadow-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 focus:ring-offset-gray-800 duration-200 transform hover:scale-105 hover:shadow-xl active:scale-95 active:brightness-90"
      >
        <i class="fas fa-download"></i>
        Download
      </button>

      {% if linkedin_url %}
      <a
        href="{{ linkedin_url }}"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center justify-center gap-2 w-full sm:w-auto px-8 py-3 border border-indigo-600 text-base font-medium rounded-md shadow-lg text-indigo-700 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500 focus:ring-offset-gray-800 duration-200 transform hover:scale-105 hover:shadow-xl active:scale-95 active:brightness-95"
      >
        <i class="fab fa-linkedin"></i>
        Add to LinkedIn
      </a>
      {% endif %}
    </div>
    <p class="text-xs text-blue-900 opacity-80 mt-4">
      Downloaded certificate is a high-resolution static png.
    </p>
  </div>
</div>

{# Confetti Trigger & html2pdf script #}
<script>
  // 1. Trigger Confetti!
  //document.addEventListener('DOMContentLoaded', () => {
  //    // Check if user prefers reduced motion
  //    const motionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
  //    if (!motionQuery || !motionQuery.matches) {
  //        // Fun confetti settings
  //        const duration = 3 * 1000; // 3 seconds
  //        const animationEnd = Date.now() + duration;
  //        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
  //
  //        function randomInRange(min, max) {
  //            return Math.random() * (max - min) + min;
  //        }
  //
  //        const interval = setInterval(function() {
  //            const timeLeft = animationEnd - Date.now();
  //
  //            if (timeLeft <= 0) {
  //                return clearInterval(interval);
  //            }
  //
  //            const particleCount = 50 * (timeLeft / duration);
  //            // Launch confetti from both sides
  //            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
  //            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
  //        }, 250);
  //    }
  //});

  // html2pdf (kept from previous)
  {% comment %} document.getElementById("download-btn").addEventListener("click", () => {
    const element = document.getElementById("certificate");

    // Clone the certificate cleanly
    const cloned = element.cloneNode(true);
    cloned.style.animation = "none";
    cloned.style.background = "white"; // Set white background
    cloned.style.color = "black";
    cloned.style.minHeight = '100vh';  // ensure full height

    // Temporarily hide unnecessary elements
    cloned
      .querySelectorAll(".no-print")
      .forEach((el) => (el.style.display = "none"));

    // Create a temporary wrapper so html2pdf has clean context
    const tempWrapper = document.createElement("div");
    tempWrapper.style.padding = "20px";
    tempWrapper.style.background = "white";

    tempWrapper.appendChild(cloned);

    document.body.appendChild(tempWrapper);
    const opt = {
      margin: 0,
      filename: "{{certi_obj.event.slug}}-certificate.pdf",
      image: { type: "jpeg", quality: 1 },
      html2canvas: {
        scale: 3,
        useCORS: true, // important if using external images like QR code
        allowTaint: true,
      },
      jsPDF: { unit: "in", format: "a4", orientation: "landscape" },
    };

    html2pdf()
      .set(opt)
      .from(tempWrapper)
      .save()

  }); {% endcomment %}
  document.getElementById("download-btn").addEventListener("click", async () => {
    const element = document.getElementById("certificate");

    // Clone the certificate cleanly
    const cloned = element.cloneNode(true);
    cloned.style.animation = "none";
    cloned.style.background = "white"; // Set white background
    cloned.style.color = "black";
    cloned.style.minHeight = '100vh';  // ensure full height

    // Temporarily hide unnecessary elements
    cloned.querySelectorAll(".no-print").forEach((el) => (el.style.display = "none"));

    // Create a temporary wrapper so html2canvas has clean context
    const tempWrapper = document.createElement("div");
    tempWrapper.style.padding = "20px";
    tempWrapper.style.background = "white";

    tempWrapper.appendChild(cloned);

    document.body.appendChild(tempWrapper);

    // Use html2canvas to capture the image
    try {
        const canvas = await html2canvas(tempWrapper, {
            scale: 3,
            useCORS: true, // important if using external images like QR code
            allowTaint: true,
        });

        // Convert the canvas to an image data URL (in PNG format)
        const imgData = canvas.toDataURL("image/png");

        // Create a link to trigger download
        const link = document.createElement("a");
        link.href = imgData;
        link.download = "{{certi_obj.event.slug}}-certificate.png"; // specify file name
        link.click();
    } catch (error) {
        console.error("Error generating image: ", error);
    } finally {
        // Remove the temporary wrapper after use
        document.body.removeChild(tempWrapper);
    }
});
</script>

{% endblock content %}
